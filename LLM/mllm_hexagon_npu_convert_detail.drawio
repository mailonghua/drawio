<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36" version="27.1.6">
  <diagram name="第 1 页" id="1yGRy3Rp8gqS7cy7YKH3">
    <mxGraphModel dx="1883" dy="567" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="v-EcrwhODqZBku7ry2aD-37" value="" style="rounded=0;whiteSpace=wrap;html=1;dashed=1;dashPattern=8 8;strokeColor=#FF00FF;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1200" y="840" width="470" height="110" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-1" target="v-EcrwhODqZBku7ry2aD-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-1" value="step1.qc_qwen2_seq_mse.py" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#0050ef;fontColor=#ffffff;strokeColor=#001DBC;" vertex="1" parent="1">
          <mxGeometry x="160" y="260" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-2" target="v-EcrwhODqZBku7ry2aD-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-9" value="量化参数" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="v-EcrwhODqZBku7ry2aD-7">
          <mxGeometry x="0.0348" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-2" value="通过&lt;b&gt;&lt;font style=&quot;color: rgb(255, 0, 0);&quot;&gt;AIMET&lt;/font&gt;&lt;/b&gt;的模拟仿真量化输出的量化文件(当中包含了所有参数的量化标准)&lt;br&gt;seqmse.json" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="160" y="340" width="200" height="70" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-4" target="v-EcrwhODqZBku7ry2aD-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-4" target="v-EcrwhODqZBku7ry2aD-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-10" value="原始模型&lt;div&gt;(这里是qwen2模型的加载类，&lt;/div&gt;&lt;div&gt;但是加载的是qwen2vl的模型权重)&lt;/div&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="v-EcrwhODqZBku7ry2aD-8">
          <mxGeometry x="-0.0239" y="-2" relative="1" as="geometry">
            <mxPoint x="-51" y="-20" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-22" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-4" target="v-EcrwhODqZBku7ry2aD-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-4" value="qwen2" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="330" y="170" width="560" height="45" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-6" target="v-EcrwhODqZBku7ry2aD-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-14" value="根据seqmse.json的量化参数量化原始模型的权重" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="v-EcrwhODqZBku7ry2aD-12">
          <mxGeometry x="-0.2778" relative="1" as="geometry">
            <mxPoint x="-81" y="-15" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-6" target="v-EcrwhODqZBku7ry2aD-17">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-6" value="step2.qc_qwen2_gptq.py" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#0050ef;fontColor=#ffffff;strokeColor=#001DBC;" vertex="1" parent="1">
          <mxGeometry x="375" y="470" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-11" value="模型量化权重&lt;br&gt;gptq_s100_cl2048.pth" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="205" y="610" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-13" value="&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AIMET SIm是通过量化仿真最终生成每个权重适合的量化参数，其仅仅输出模型量化文件，而元模型没有得到改动" style="text;strokeColor=none;align=left;fillColor=none;html=1;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-40" y="340" width="180" height="65" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-15" value="&lt;b&gt;&amp;nbsp;model = modeling_qwen2.Qwen2ForCausalLM.from_pretrained(model_id, config=llm_config)&lt;/b&gt;&lt;br&gt;&lt;ul&gt;&lt;li&gt;当中的modeling_qwen2.Qwen2ForCausalLM.from_pretrained是源自transformers的qwen2模型下载函数&lt;/li&gt;&lt;li&gt;model_id：是Qwen2vl的模型路径&lt;/li&gt;&lt;li&gt;结果：也就是用了Qwen2的模型对象读取了只与LLM相关的权重。对vit相关的权重都进行了忽略&lt;/li&gt;&lt;/ul&gt;" style="text;strokeColor=none;align=left;fillColor=none;html=1;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="300" y="60" width="570" height="100" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-25" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-17" target="v-EcrwhODqZBku7ry2aD-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-17" value="gptq_s100_cl2048.encodings" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="485" y="610" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-19" value="实际量化的权重参数&lt;div&gt;(与seqmse.json高度相同，这里存储了模型实际的量化参数)&lt;/div&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="1">
          <mxGeometry x="650" y="550" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-24" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-20" target="v-EcrwhODqZBku7ry2aD-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-28" value="再次进行了AIMET SIM/模型精度量化" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="v-EcrwhODqZBku7ry2aD-24">
          <mxGeometry x="0.284" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-27" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-20" target="v-EcrwhODqZBku7ry2aD-26">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-29" value="从原模型上获得" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="v-EcrwhODqZBku7ry2aD-27">
          <mxGeometry x="-0.193" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-31" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-20" target="v-EcrwhODqZBku7ry2aD-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-36" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-20" target="v-EcrwhODqZBku7ry2aD-35">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-20" value="step4.qc_qwen2_kv.py" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#0050ef;fontColor=#ffffff;strokeColor=#001DBC;" vertex="1" parent="1">
          <mxGeometry x="650" y="770" width="330" height="50" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-23" value="保存了量化参数kv_cl2048_sim.json" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="405" y="890" width="262" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-26" value="嵌入权重&lt;div&gt;(embedding_weights_151936x1536.raw)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="705" y="890" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-30" value="ONNX(qwen2_vl_2b_AR1023.onnx)&lt;br&gt;该是整个的计算图" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="950" y="890" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-32" value="example2/qnn_model_prepare.py" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#0050ef;fontColor=#ffffff;strokeColor=#001DBC;" vertex="1" parent="1">
          <mxGeometry x="655" y="1100" width="270" height="50" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-35" value="&lt;span style=&quot;text-align: left;&quot;&gt;qwen2_vl_2b_kvcache.py&lt;/span&gt;&lt;div style=&quot;text-align: left;&quot;&gt;(由程序构建的模型执行图)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1210" y="890" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-39" value="kv_mha_prepared_model = model_preparer.prepare_model(...)" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="1330" y="840" width="350" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-40" target="v-EcrwhODqZBku7ry2aD-41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-40" value="Qwen2/Qwen2vl weight" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="1120" y="690" width="130" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-41" target="v-EcrwhODqZBku7ry2aD-44">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-49" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-41" target="v-EcrwhODqZBku7ry2aD-47">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1410" y="660" />
              <mxPoint x="1895" y="660" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-41" value="kv_mha_prepared_model = model_preparer.prepare_model(...)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#0050ef;fontColor=#ffffff;strokeColor=#001DBC;" vertex="1" parent="1">
          <mxGeometry x="1310" y="690" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-44" value="&lt;div&gt;qwen2_vl_2b_kvcache.py&lt;/div&gt;&lt;div&gt;(由程序构建的模型执行图)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1550" y="690" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-47" target="v-EcrwhODqZBku7ry2aD-50">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-47" value="&lt;div&gt;模型的封装:&lt;/div&gt;sim_fpm = LLMForwardPassManager(...)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#0050ef;fontColor=#ffffff;strokeColor=#001DBC;" vertex="1" parent="1">
          <mxGeometry x="1780" y="690" width="230" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-50" target="v-EcrwhODqZBku7ry2aD-52">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-50" value="&amp;nbsp;quantsim = QuantizationSimModel(model=sim_fpm.model，....)&lt;div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#0050ef;fontColor=#ffffff;strokeColor=#001DBC;" vertex="1" parent="1">
          <mxGeometry x="2050" y="690" width="280" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-55" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-52" target="v-EcrwhODqZBku7ry2aD-54">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-57" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="v-EcrwhODqZBku7ry2aD-52" target="v-EcrwhODqZBku7ry2aD-56">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-52" value="特定量化&lt;div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="2370" y="690" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-54" value="保存量化输出文件&lt;br&gt;kv_cl2048_sim.json&lt;br&gt;&lt;div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="2490" y="630" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="v-EcrwhODqZBku7ry2aD-56" value="ONNX模型文件&lt;div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="2490" y="710" width="120" height="40" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
